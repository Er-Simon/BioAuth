{% extends "base.html" %}
{% block title %}Login{% endblock %}
{% block description %}Once you have completed enrollment, provide the required information to access the system.{%endblock %}

{% block head %}
  {{ super() }}
  <style type="text/css">
    #loading {
      background: url(static/loading.gif) center 50% no-repeat;
      background-color: rgb(255, 255, 255);
      box-shadow: inset 0 0 50px rgb(0 0 0 / 10%);
      z-index: 10;
      top:0; 
      left:0; 
      position:fixed; 
      height:100%; 
      width:100%;
      visibility: hidden;
    }

    #number {
      letter-spacing: 0.15em;
    }

    .space {
      height: 70px;
      width: 10px;
      background-color: transparent;
    }

    video {
      background-color: grey;
      width: 50%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    @media only screen and (max-width: 768px) {
      video {
        width: 100%;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div id="loading">
  
</div>

<div class="form-group row mb-3">
  <p>Take your photo with the number generated by the system to be recognize</p>
  <div class="row">
    <label class="col-sm-3 col-form-label">Generated number:</label>
    <label class="col-sm-9 h3" id="number">
     {{ session['number'] }}
    </label>
  </div>
</div>

<div class="my-5">
  <video autoplay id="video"></video>
  <button type="button" class="btn btn-secondary mx-auto d-block m-3" id="take_photo">Take Photo</button>
</div>

<p>Record your voice to be verified. Say your passphrase.</p>
<div class="my-5 col-md-12 text-center">
    <button type="button" class="btn btn-danger" id="recordButton">Record</button>
    <button type="button" class="btn btn-secondary" id="stopButton" disabled>Stop</button>  
</div>

<div class="space"></div>

<div class="m-3 mb-4">
  <button type="button" class="btn btn-primary btn-lg mx-auto d-block m-3" id="login">Login</button>
</div>

<script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
<script src="static/app.js"></script>

<script type="text/javascript">
  stopButton.addEventListener("click", sendRecording);

  function alert_message() {
    alert("You have to log in before you can see the evaluation section");
  }

  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function (stream) {
      video.srcObject = stream;
      video.play();
    });
  }

  document.getElementById("take_photo").addEventListener("click", function() {
    var video = document.getElementById('video');

    if (video.paused) {
      video.play();
    }

    var height = video.videoHeight;
    var width = video.videoWidth;

    while (width > 400 || height > 300) {
      width = width * 0.95;
      height = height * 0.95;
    }

    var canvas = document.createElement('canvas');
    canvas.height = height;
    canvas.width = width;
    var context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, canvas.width, canvas.height);

    var number = document.getElementById("number").innerText;

    formdata.append("photo", canvas.toDataURL("image/jeg"))
    formdata.append("number", number)    

    video.pause();
  });


  document.getElementById("login").addEventListener("click", function() {
    if (!formdata.has("photo")) {
      alert("You need to take a picture before you can login");
      return;
    }

    if (!formdata.has("voice")) {
      alert("You need to record your voice before you can login");
      return;
    }

    //console.log(formdata);

    var response;

    var loading_element = document.getElementById("loading");

    loading_element.style.visibility = "visible";

    $.ajax({
      type: "POST",
      url: "{{ url_for('auth_login') }}",
      async: true,
      data: formdata,
      processData: false,
      contentType: false,
      success: function(responseData) { hanldeLoginResponse(responseData) },
      error: function(textStatus, errorThrown) {
        console.error("Status: " + textStatus);
        console.error("Error: " + errorThrown);
        hanldeLoginResponse(-1);
      },
      timeout: 60000
    });
  });


  function hanldeLoginResponse(response) {
    var loading_element = document.getElementById("loading");
    loading_element.style.visibility = "hidden";

    if (response == -1) {
      if (!alert("An internal error occurred, please try again")) {
        window.location.reload();
      }
      return;
    }

    if (!response.startsWith("True")) {
      alert(response);
      location.reload()
      return;
    }

    location.replace("/evaluation")
  }

</script>

{% if alert_message == true %}
<script type="text/javascript">alert_message()</script>
{% endif %}
{% endblock %}
